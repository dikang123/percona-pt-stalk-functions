####
# Example:
# pt-stalk --variable=slow_query_is_running --threshold=0 --cycles=1 --function /root/stalk-trigger.sh
####

trg_plugin() {

long_query_time=5
long_queries_running=5
really_long_query_time=150
really_long_queries_running=1

too_many_slow=$(mysql -ss <<< "
-- QUERYSTART
SELECT COUNT(*) >= $long_queries_running FROM INFORMATION_SCHEMA.PROCESSLIST
 WHERE ID<>CONNECTION_ID() AND
 COMMAND NOT IN ('Binlog Dump','Connect','Daemon','Sleep')
 AND USER<>'system user'
 AND Time >= $long_query_time
-- QUERYEND
")


too_many_really_slow=$(mysql -ss <<< "
-- QUERYSTART
SELECT COUNT(*) >= $long_queries_running FROM INFORMATION_SCHEMA.PROCESSLIST
 WHERE ID<>CONNECTION_ID() AND
 COMMAND NOT IN ('Binlog Dump','Connect','Daemon','Sleep')
 AND USER<>'system user'
 AND Time >= $long_query_time
-- QUERYEND
")


if [[ $too_many_slow -eq 1 || $too_many_really_slow -eq 1 ]]
 then echo 1
 else echo 0
fi


}
